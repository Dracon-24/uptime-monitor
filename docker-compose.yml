version: '3.8'

services:
  # Graphite + Carbon for metrics storage
  graphite:
    image: graphiteapp/graphite-statsd:latest
    container_name: uptime-graphite
    restart: unless-stopped
    ports:
      - "8081:80"           # Graphite web interface
      - "2003:2003"       # Carbon plaintext receiver
      - "2004:2004"       # Carbon pickle receiver
      - "8125:8125/udp"   # StatsD UDP
      - "8126:8126"       # StatsD admin
    volumes:
      - graphite-data:/opt/graphite/storage
    environment:
      - GRAPHITE_TIME_ZONE=UTC

  # Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: uptime-grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    depends_on:
      - graphite

  # Redis for caching
  redis:
    image: redis:7-alpine
    container_name: uptime-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  # Your Node.js web app
  webapp:
    build: .
    container_name: uptime-webapp
    restart: unless-stopped
    ports:
      - "8085:3000"
    depends_on:
      - redis
      - graphite
    environment:
      - NODE_ENV=production

volumes:
  graphite-data:
  grafana-data:
  redis-data:
